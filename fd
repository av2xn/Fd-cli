#!/data/data/com.termux/files/usr/bin/bash

fdroid_url="https://f-droid.org/repo"
index_file="fdroid-index.json"

function update_index() {
    echo "[*] F-Droid veritabanı indiriliyor..."
    curl -s -L -o "$index_file" "$fdroid_url/index-v1.json"
}

function search_apps() {
    [[ ! -f "$index_file" ]] && update_index
    read -p "[?] Uygulama adını girin: " query
    echo "[*] Eşleşmeler bulunuyor..."
    jq -r --arg q "$query" '
      .apps[]
      | select(.packageName | test($q;"i"))
      | "\(.localized["en-US"].name // "İsim yok") | \(.packageName)_\(.suggestedVersionCode).apk"
    ' "$index_file" | head -n 5
}

function install_app() {
    read -p "[?] Paket adı + versiyon girin (örnek: org.mozilla.fennec_fdroid_123.apk): " apkname

    if [[ ! "$apkname" =~ \.apk$ ]]; then
        echo "[!] Geçerli bir .apk adı girilmedi."
        return
    fi

    echo "[*] APK indiriliyor: $apkname"
    curl -s -L -o "$apkname" "$fdroid_url/$apkname"

    if [[ ! -s "$apkname" ]]; then
        echo "[!] İndirme başarısız veya dosya boş."
        rm -f "$apkname"
        return
    fi

    echo -e "\n[?] Uygulama nasıl yüklensin?"
    echo "1 - root (pm install)"
    echo "2 - GUI yükleyici (apk installer ekranı açılır)"
    read -p "> " method

    if [[ "$method" == "1" ]]; then
        echo "[*] Root ile yükleniyor..."
        su -c "pm install -r $PWD/$apkname" && echo "[✓] Yüklendi!" || echo "[!] Yükleme başarısız."
    elif [[ "$method" == "2" ]]; then
        echo "[*] GUI yükleyici açılıyor..."
        termux-open --content-type application/vnd.android.package-archive "$PWD/$apkname"
        echo "[✓] Lütfen yükleme ekranında onay verin."
    else
        echo "[!] Geçersiz seçim. Kurulum iptal."
        rm -f "$apkname"
        return
    fi

    # rm -f "$apkname" # Not: GUI yükleyicide yüklenmeden silme riskli olabilir
}

function usage() {
    echo "Kullanım: fd <s|i|u>"
    echo "  s  – Uygulama ara"
    echo "  i  – Uygulama yükle (.apk adı girerek)"
    echo "  u  – Veritabanını güncelle"
}

case "$1" in
    s) search_apps ;;
    i) install_app ;;
    u) update_index ;;
    *) usage ;;
esac
