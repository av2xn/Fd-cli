#!/data/data/com.termux/files/usr/bin/bash

fdroid_url="https://f-droid.org/repo"
index_file="fdroid-index.json"

function update_index() {
    echo "[*] F-Droid veritabanı indiriliyor..."
    curl -s -L -o $index_file "$fdroid_url/index-v1.json"
}

function search_apps() {
    [[ ! -f "$index_file" ]] && update_index
    read -p "[?] Uygulama adını girin: " query
    echo "[*] Eşleşmeler bulunuyor..."
    jq -r --arg q "$query" '
      .apps[]
      | select(.packageName | test($q;"i"))
      | "\(.localized["en-US"].name // "İsim yok") | \(.packageName)_\(.suggestedVersionCode).apk"
    ' "$index_file" | head -n 5
}

function install_app() {
    read -p "[?] Paket adını girin (örnek: org.mozilla.fennec_fdroid_123.apk): " apkname

    if [[ ! "$apkname" =~ \.apk$ ]]; then
        echo "[!] Geçerli bir .apk adı girin."
        return
    fi

    echo "[*] APK indiriliyor: $apkname"
    curl -s -L -o "$apkname" "$fdroid_url/$apkname"

    echo -e "\n[?] Uygulama nasıl yüklensin?"
    echo "1 - root (pm install)"
    echo "2 - shizuku (rish)"
    read -p "> " choice

    if [[ "$choice" == "1" ]]; then
        echo "[*] Root ile yükleniyor..."
        su -c "pm install -r $PWD/$apkname" && echo "[✓] Yüklendi!" || echo "[!] Hata!"
    elif [[ "$choice" == "2" ]]; then
        echo "[*] Shizuku ile yükleniyor..."
        ./rish pm install -r $PWD/$apkname && echo "[✓] Yüklendi!" || echo "[!] Hata!"
    else
        echo "[!] Geçersiz seçim!"
        return
    fi

    rm -f "$apkname"
}

function usage() {
    echo "Kullanım: fd <s|i|u>"
    echo "  s  – Uygulama ara"
    echo "  i  – Uygulama yükle (.apk adı girerek)"
    echo "  u  – Veritabanını güncelle"
}

case "$1" in
    s) search_apps ;;
    i) install_app ;;
    u) update_index ;;
    *) usage ;;
esac
