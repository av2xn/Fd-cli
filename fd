#!/bin/bash

MODE=root  # setup.sh bu satırı 'shizuku' olarak değiştirebilir

# root ya da shizuku komutu
if [ "$MODE" = "shizuku" ]; then
  SUDO="rish"
else
  SUDO="su -c"
fi

FDROID_INDEX="fdroid-index.json"
REPO_URL="https://f-droid.org/repo"

function update_index() {
  if [ ! -f "$FDROID_INDEX" ]; then
    echo "[*] F-Droid veritabanı indiriliyor..."
    curl -L -o "$FDROID_INDEX" "$REPO_URL/index-v1.json"
  fi
}

function search_app() {
  read -p "[?] Uygulama adını girin: " q
  update_index
  echo "[*] Eşleşmeler bulunuyor..."

  jq -r --arg q "$q" '
    .apps[] | select(.packageName | test($q; "i") or (.localized["en-US"].name // "" | test($q; "i"))) |
    "\(.localized["en-US"].name) | \(.packageName)_\(.suggestedVersionCode).apk"
  ' "$FDROID_INDEX"
}

function install_app() {
  read -p "[?] Uygulama paket adını girin: " pkg
  update_index
  version=$(jq -r --arg pkg "$pkg" '
    .apps[] | select(.packageName == $pkg) | .suggestedVersionCode
  ' "$FDROID_INDEX")

  if [ "$version" = "null" ] || [ -z "$version" ]; then
    echo "[!] Paket bulunamadı: $pkg"
    exit 1
  fi

  apk="${pkg}_${version}.apk"
  echo "[*] $apk indiriliyor..."
  curl -s -L -o "$apk" "$REPO_URL/$apk"

  if [ ! -s "$apk" ]; then
    echo "[!] APK indirilemedi veya dosya boş."
    rm -f "$apk"
    exit 1
  fi

  echo "[*] Uygulama yükleniyor..."
  $SUDO pm install "$apk" && echo "[✓] Yükleme tamamlandı." || echo "[!] Yükleme başarısız."
  rm -f "$apk"
}

case "$1" in
  s) search_app ;;
  i) install_app ;;
  u)
    echo "[*] Veritabanı güncelleniyor..."
    curl -L -o "$FDROID_INDEX" "$REPO_URL/index-v1.json"
    ;;
  *)
    echo "Kullanım: fd <s|i|u>"
    echo "  s  → Uygulama ara"
    echo "  i  → Uygulama yükle"
    echo "  u  → Veritabanını güncelle"
    ;;
esac
