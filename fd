#!/data/data/com.termux/files/usr/bin/bash

fd_index="fdroid-index.json"
fd_url="https://f-droid.org/repo/index-v1.json"

update_index() {
  echo "[*] Veritabanı indiriliyor..."
  curl -# -L -o "$fd_index" "$fd_url"
}

search_app() {
  if [ ! -f "$fd_index" ]; then
    update_index
  fi
  read -p "[?] Uygulama adını girin: " query
  echo "[*] Eşleşmeler aranıyor..."

  jq -r --arg q "$query" '
    .apps[]
    | select((.localized["en-US"].name // .packageName) | test($q; "i"))
    | "\(.localized["en-US"].name // "Bilinmeyen") | \(.packageName)_\(.suggestedVersionCode).apk"
  ' "$fd_index" | head -10
}

install_app() {
  read -p "[?] Paket adını girin (örnek: org.mozilla.fennec_fdroid): " pkg
  if [ ! -f "$fd_index" ]; then
    update_index
  fi

  version=$(jq -r --arg p "$pkg" '
    .apps[] | select(.packageName == $p) | .suggestedVersionCode
  ' "$fd_index")

  if [[ -z "$version" || "$version" == "null" ]]; then
    echo "[!] Sürüm bulunamadı!"
    exit 1
  fi

  file="${pkg}_${version}.apk"
  url="https://f-droid.org/repo/$file"

  echo "[*] APK indiriliyor: $file"
  curl -L -o "$file" "$url"

  if [[ ! -s "$file" ]]; then
    echo "[!] Dosya indirilemedi veya boş."
    rm -f "$file"
    exit 1
  fi

  echo
  echo "[?] Uygulama nasıl yüklensin?"
  echo "1) Root (Magisk)"
  echo "2) Shizuku (rish)"
  read -p "Seçiminiz (1/2): " method

  if [[ "$method" == "1" ]]; then
    echo "[*] Root ile kurulum yapılıyor..."
    su -c "pm install -r $PWD/$file"
  elif [[ "$method" == "2" ]]; then
    echo "[*] Shizuku ile kurulum yapılıyor..."
    ./rish pm install -r "$PWD/$file"
  else
    echo "[!] Geçersiz seçim. Kurulum iptal edildi."
    rm -f "$file"
    exit 1
  fi

  echo "[✓] Kurulum tamamlandı."
  rm -f "$file"
}

case "$1" in
  s) search_app ;;
  i) install_app ;;
  u) update_index ;;
  *)
    echo "Kullanım: fd <s|i|u>"
    echo "  s  → Uygulama ara"
    echo "  i  → Uygulama yükle"
    echo "  u  → Veritabanını güncelle"
    ;;
esac
